version: '3.9'

services:
  mongodb:
    image: mongo
    volumes:
      - mongodb_data:/data/db
    env_file:
      - ./env/mongodb.env
    healthcheck:
      test: ["CMD-SHELL", "mongo --eval 'db.adminCommand(\"ping\")'"]
      interval: 30s          # Time between checks
      timeout: 10s           # Time to wait for the check to complete
      retries: 5             # Number of retries before marking as unhealthy
      start_period: 10s      # Time to wait before starting the health checks

  user:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    ports:
      - 80:3000
    env_file:
      - ./localEnv/user-service.env
    depends_on:
      mongodb:
        condition: service_healthy

  postgreSQL:
    image: postgres
    restart: always
    shm_size: 128mb
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: root
      POSTGRES_PASSWORD: password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U root"]
      interval: 30s          # Time between checks
      timeout: 10s           # Time to wait for the check to complete
      retries: 5             # Number of retries before marking as unhealthy
      start_period: 10s      # Time to wait before starting the health checks

  adminer:
    image: adminer
    restart: always
    ports:
      - 8080:8080

  wallet:
    build:
      context: ./wallet-service
      dockerfile: Dockerfile
    ports:
      - 80:3001
    env_file:
      - ./localEnv/wallet-service.env
    depends_on:
      - user

  gift:
    build:
      context: ./gift-service
      dockerfile: Dockerfile
    ports:
      - 80:3002
    env_file:
      - ./localEnv/gift-service.env
    depends_on:
      - wallet

  stream:
    build:
      context: ./stream-service
      dockerfile: Dockerfile
    ports:
      - 80:3003
    env_file:
      - ./localEnv
    depends_on:
      - gift
      #dynamoDB

volumes:
  postgres_data:
  mongodb_data: